name: Label-Based Checklist Verification

on:
  workflow_call:
    inputs:
      runner:
        required: false
        type: string
        default: "ubuntu-latest"
    secrets:
      github-token:
        required: false

jobs:
  main:
    name: Verify Label-Based Checklist Completion
    runs-on: ubuntu-latest
    # Only run on PRs (skip non-PR issue comments)
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    steps:
      - name: Get PR number
        id: pr-number
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request' || context.eventName === 'pull_request_target') {
              return context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              return context.payload.issue.number;
            }
            return null;

      - name: Get label-based checklist comment
        id: label-checklist
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-number.outputs.result }};
            // Find label-based checklist comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const labelComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ·ï¸ Label-Based Checklist')
            );

            return labelComment ? labelComment.body : '';

      - name: Verify checklist items
        id: verify
        uses: actions/github-script@v7
        with:
          script: |
            const labelChecklistBody = ${{ steps.label-checklist.outputs.result }};

            // Only check label-based checklist (ignore PR body)
            const checklistBody = labelChecklistBody;

            // Count checkbox items in label-based checklist only
            // Match checkboxes followed by bold text (actual checklist items)
            // This excludes code examples in backticks and other non-checklist text
            const uncheckedCheckboxes = (checklistBody.match(/^- \[ \] \*\*/gm) || []).length;
            const checkedCheckboxes = (checklistBody.match(/^- \[x\] \*\*/gmi) || []).length;
            const totalCheckboxes = uncheckedCheckboxes + checkedCheckboxes;

            console.log(`Label-based checklist checkboxes: ${checkedCheckboxes}/${totalCheckboxes} (${uncheckedCheckboxes} unchecked)`);

            // If no label checklist exists, skip verification
            if (!checklistBody || totalCheckboxes === 0) {
              console.log('No label-based checklist found. Skipping verification.');
              core.setOutput('status', 'success');
              core.setOutput('message', 'No label-based checklist requirements');
              core.setOutput('completion', 100);
              return {
                status: 'success',
                message: 'No label-based checklist requirements',
                completion: 100,
                checked: 0,
                total: 0
              };
            }

            // Calculate completion percentage
            const completionPercent = totalCheckboxes > 0
              ? Math.round((checkedCheckboxes / totalCheckboxes) * 100)
              : 100;

            // Determine status - only 100% passes
            let status = 'success';
            let message = `Label-based checklist: ${checkedCheckboxes}/${totalCheckboxes} items completed (${completionPercent}%)`;

            if (completionPercent < 100) {
              status = 'failure';
              message = `Label-based checklist incomplete: ${checkedCheckboxes}/${totalCheckboxes} items completed (${completionPercent}%). All items must be completed (100% required).`;
            }

            core.setOutput('status', status);
            core.setOutput('message', message);
            core.setOutput('completion', completionPercent);

            return {
              status,
              message,
              completion: completionPercent,
              checked: checkedCheckboxes,
              total: totalCheckboxes
            };

      - name: Report results
        env:
          STATUS: ${{ steps.verify.outputs.status }}
          MESSAGE: ${{ steps.verify.outputs.message }}
        run: |
          echo "$MESSAGE"
          if [ "$STATUS" = "failure" ]; then
            echo "::error::Label-based checklist verification failed. Please complete required checklist items in the label-based checklist comment."
            exit 1
          else
            echo "âœ… Label-based checklist verification passed!"
          fi
