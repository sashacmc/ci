name: Check labels

on:
  workflow_call:
    inputs:
      runner:
        required: false
        type: string
        default: "ubuntu-latest"
    secrets:
      github-token:
        required: true

jobs:
  main:
    runs-on: ${{ inputs.runner }}
    env:
      REQUIRED_LABELS: '["api-sync", "breaking-change", "bug", "ci", "dependencies", "documentation", "enhancement", "new feature", "internal"]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout checklist definitions
        uses: actions/checkout@v4
        with:
          repository: sashacmc/ci
          sparse-checkout: |
            pr-checklists.json
          path: ci_tmp
          sparse-checkout-cone-mode: false

      - name: Load checklist definitions
        id: load-defs
        run: |
          echo "defs<<EOF" >> $GITHUB_OUTPUT
          cat ci_tmp/pr-checklists.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR labels and generate checklists
        id: generate
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            // Load checklist definitions
            const definitions = JSON.parse(`${{ steps.load-defs.outputs.defs }}`);
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const labels = pr.labels.map(l => l.name);
            console.log('PR Labels:', labels);

            // Generate checklists based on labels
            const checklists = [];
            const labelDefinitions = definitions.label_checklists;

            for (const label of labels) {
              if (labelDefinitions[label]) {
                const def = labelDefinitions[label];
                const items = def.items.map(item => `- [ ] ${item}`).join('\n');

                const checklistText = [
                  `## ${def.title}`,
                  '',
                  def.description,
                  '',
                  items,
                  '',
                  def.footer || ''
                ].join('\n').trim();

                checklists.push(checklistText);
              }
            }

            // Generate final comment
            let comment = '';
            const required_labels = JSON.parse(process.env.REQUIRED_LABELS);
            const hasRequiredLabel = labels.some(l => required_labels.includes(l));

            if (!hasRequiredLabel) {
              const labelsList = labels.length > 0 ? labels.map(l => `\`${l}\``).join(', ') : '_No labels_';
              const requiredLabelsList = required_labels.map(l => `\`${l}\``).join(', ');
              comment = [
                '## ðŸ·ï¸ Label-Based Checklist',
                '',
                '**No specific label requirements detected.**',
                '',
                `Current labels: ${labelsList}`,
                '',
                `Add one of these labels to this PR to see relevant checklist items: ${requiredLabelsList}`,
                '',
                '---',
                '*This comment updates automatically when labels change.*'
              ].join('\n');
            } else {
              const labelsList = labels.map(l => `\`${l}\``).join(', ');
              comment = [
                '## ðŸ·ï¸ Label-Based Checklist',
                '',
                'Based on the labels applied to this PR, please complete these additional requirements:',
                '',
                `**Labels:** ${labelsList}`,
                '',
                '---',
                '',
                checklists.join('\n\n---\n\n'),
                '',
                '---',
                '',
                '**Instructions:**',
                '1. Check off items as you complete them (change `- [ ]` to `- [x]`)',
                '2. Edit this comment to update checkboxes',
                '3. The PR checklist CI will verify these are completed',
                '',
                '*This comment updates automatically when labels change.*'
              ].join('\n');
            }

            return JSON.stringify({ comment, labelCount: labels.length, checklistCount: checklists.length });

      - name: Post or update checklist comment
        uses: actions/github-script@v7
        env:
          RESULT_JSON: ${{ steps.generate.outputs.result }}
          GH_TOKEN: ${{ secrets.github-token }}
        with:
          script: |
            const result = JSON.parse(process.env.RESULT_JSON);
            const comment = result.comment;

            // Find existing label-based checklist comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ·ï¸ Label-Based Checklist')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing label-based checklist comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
              console.log('Created new label-based checklist comment');
            }

            console.log(`Generated ${result.checklistCount} checklist(s) for ${result.labelCount} label(s)`);

      - name: Check for required labels
        uses: actions/github-script@v7
        env:
          RESULT_JSON: ${{ steps.generate.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.RESULT_JSON);
            const required_labels = JSON.parse(process.env.REQUIRED_LABELS);

            if (result.checklistCount === 0) {
              core.setFailed(`âŒ This PR must have at least one of the required labels: ${required_labels.join(', ')}`);
            } else {
              console.log('âœ… PR has required labels');
            }

      - name: Get label-based checklist comment
        id: label-checklist
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            // Find label-based checklist comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const labelComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ·ï¸ Label-Based Checklist')
            );

            return labelComment ? labelComment.body : '';

      - name: Verify checklist items
        id: verify
        uses: actions/github-script@v7
        env:
          LABEL_CHECKLIST: ${{ steps.label-checklist.outputs.result }}
        with:
          result-encoding: string
          script: |
            const labelChecklistBody = process.env.LABEL_CHECKLIST;

            // Count all checkboxes in label checklist comment only
            const allCheckboxes = (labelChecklistBody.match(/- \[[ x]\]/gi) || []).length;
            const checkedCheckboxes = (labelChecklistBody.match(/- \[x\]/gi) || []).length;
            const uncheckedCheckboxes = allCheckboxes - checkedCheckboxes;

            console.log(`Label checklist: ${checkedCheckboxes}/${allCheckboxes} checked`);
            console.log(`Unchecked: ${uncheckedCheckboxes}`);

            // Simple rule: ALL boxes must be checked
            let status = 'success';
            let message = `All label checklist items completed (${allCheckboxes}/${allCheckboxes})`;

            if (uncheckedCheckboxes > 0) {
              status = 'failure';
              message = `Label checklist incomplete: ${uncheckedCheckboxes} unchecked item(s)`;
            }

            core.setOutput('status', status);
            core.setOutput('message', message);
            core.setOutput('checked', checkedCheckboxes);
            core.setOutput('total', allCheckboxes);
            core.setOutput('unchecked', uncheckedCheckboxes);

            return JSON.stringify({
              status,
              message,
              checked: checkedCheckboxes,
              total: allCheckboxes,
              unchecked: uncheckedCheckboxes
            });

      - name: Report checklist status
        uses: actions/github-script@v7
        env:
          VERIFY_RESULT: ${{ steps.verify.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.VERIFY_RESULT);
            const status = '${{ steps.verify.outputs.status }}';
            const message = `${{ steps.verify.outputs.message }}`;

            console.log(`Status: ${status}`);
            console.log(`Message: ${message}`);

      - name: Fail if checklist incomplete
        if: steps.verify.outputs.status == 'failure'
        run: |
          echo "::error::Label-based checklist verification failed. Please complete all required checklist items in the bot comment."
          exit 1
